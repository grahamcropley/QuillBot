name: Deploy to Azure Container Apps

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  AZURE_ACR_NAME: ${{ vars.AZURE_ACR_NAME }}
  AZURE_APP_NAME: ${{ vars.AZURE_APP_NAME }}
  AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
  AZURE_LOG_ANALYTICS_NAME: ${{ vars.AZURE_LOG_ANALYTICS_NAME }}
  AZURE_STORAGE_ACCOUNT_NAME: ${{ vars.AZURE_STORAGE_ACCOUNT_NAME }}
  DATA_SHARE_NAME: ${{ vars.DATA_SHARE_NAME || 'quillbot-data' }}
  CONFIG_SHARE_NAME: ${{ vars.CONFIG_SHARE_NAME || 'opencode-config' }}
  WEB_IMAGE_NAME: ${{ vars.WEB_IMAGE_NAME || 'quillbot-web' }}
  OPENCODE_IMAGE_NAME: ${{ vars.OPENCODE_IMAGE_NAME || 'quillbot-opencode' }}
  OPENCODE_VERSION: ${{ vars.OPENCODE_VERSION || 'latest' }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure Resource Group
        run: az group create --name "$AZURE_RESOURCE_GROUP" --location "$AZURE_LOCATION"

      - name: Ensure ACR and fetch credentials
        id: acr
        run: |
          if ! az acr show --name "$AZURE_ACR_NAME" --resource-group "$AZURE_RESOURCE_GROUP" > /dev/null 2>&1; then
            az acr create \
              --name "$AZURE_ACR_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --location "$AZURE_LOCATION" \
              --sku Basic \
              --admin-enabled true
          else
            az acr update --name "$AZURE_ACR_NAME" --admin-enabled true
          fi
          LOGIN_SERVER=$(az acr show --name "$AZURE_ACR_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --query loginServer -o tsv)
          USERNAME=$(az acr credential show --name "$AZURE_ACR_NAME" --query username -o tsv)
          PASSWORD=$(az acr credential show --name "$AZURE_ACR_NAME" --query "passwords[0].value" -o tsv)
          echo "loginServer=$LOGIN_SERVER" >> "$GITHUB_OUTPUT"
          echo "username=$USERNAME" >> "$GITHUB_OUTPUT"
          echo "password=$PASSWORD" >> "$GITHUB_OUTPUT"

      - name: Docker login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.acr.outputs.loginServer }}
          username: ${{ steps.acr.outputs.username }}
          password: ${{ steps.acr.outputs.password }}

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: containers/web/Dockerfile
          push: true
          tags: ${{ steps.acr.outputs.loginServer }}/${{ env.WEB_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Build and push OpenCode image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: containers/opencode/Dockerfile
          push: true
          build-args: |
            OPENCODE_VERSION=${{ env.OPENCODE_VERSION }}
          tags: ${{ steps.acr.outputs.loginServer }}/${{ env.OPENCODE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Deploy Container Apps
        run: |
          WEB_IMAGE="${{ steps.acr.outputs.loginServer }}/${WEB_IMAGE_NAME}:${IMAGE_TAG}"
          OPENCODE_IMAGE="${{ steps.acr.outputs.loginServer }}/${OPENCODE_IMAGE_NAME}:${IMAGE_TAG}"
          az deployment group create \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --template-file infra/azure/main.bicep \
            --parameters \
              location="$AZURE_LOCATION" \
              appName="$AZURE_APP_NAME" \
              environmentName="$AZURE_ENV_NAME" \
              logAnalyticsName="$AZURE_LOG_ANALYTICS_NAME" \
              acrName="$AZURE_ACR_NAME" \
              storageAccountName="$AZURE_STORAGE_ACCOUNT_NAME" \
              dataShareName="$DATA_SHARE_NAME" \
              configShareName="$CONFIG_SHARE_NAME" \
              webImage="$WEB_IMAGE" \
              opencodeImage="$OPENCODE_IMAGE" \
              opencodeApiKey="${{ secrets.OPENCODE_API_KEY }}"
