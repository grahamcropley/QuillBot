# QuillBot TODO & Bug Investigation

## Current Issues

### 1. Question Tool Status Not Updating After Answer ❌

**Symptoms**:

- Question tool bubble shows status but doesn't update to "completed" after user answers
- Status remains stuck on "running" even though question has been answered

**Test Case**:

- Project: `proj_1770307492294_oe1up1x`
- URL: `http://localhost:3000/project/proj_1770307492294_oe1up1x` (Test B)

**Root Cause**:
The `answerQuestion()` function in `src/stores/project-store.ts` (lines 369-456) only updates:

- `questionData.answered = true`
- `questionData.answers = [...]`

But it does NOT update the question tool part's `state.status` from "running" to "completed".

**Solution**:
In `answerQuestion()`, after finding the question message, update the parts array:

```typescript
const updatedParts = m.parts?.map((part) => {
  if (part.type === "tool" && part.tool === "question") {
    return {
      ...part,
      state: {
        ...part.state,
        status: "completed" as const,
      },
    };
  }
  return part;
});
```

Then include `updatedParts` in the message update and persist via PATCH API.

**Files to Modify**:

- `src/stores/project-store.ts` - `answerQuestion()` function (lines 369-456)

---

### 2. Orphaned Step-Finish Bubbles ✅ FIXED

**Symptoms**:

- Multiple standalone "[TOOL] Step finished (tool-calls)" bubbles appeared in assistant messages
- They tried to merge into the preceding tool bubble but couldn't

**Root Cause**:
Step-finish parts with `reason: "tool-calls"` are purely token count metadata. Tool completions are already signaled via explicit `part.state.status` updates (pending → running → completed/error). These step-finish events added no user-visible value and created orphan bubbles when no mergeable tool existed.

**Solution Implemented**:
Skip step-finish parts when `reason === "tool-calls"` in `deriveActivityItems()`. Keep step-finish for meaningful reasons (stop, length, etc.).

**Files Modified**:

- `src/utils/conversation-render-model.ts` - lines 238-270

**Implementation**:

```typescript
if (part.type === "step-finish") {
  // Skip internal tool-calls metadata - these only show token counts
  // Tool completions are already signaled via part.state.status updates
  if (part.reason === "tool-calls") {
    continue;
  }

  // Keep step-finish for meaningful reasons (stop, length, etc.)
  // ... rest of step-finish handling
}
```

---

## Recently Fixed Issues ✅

### Fixed: "busy" Status Shows Literal Text (COMPLETED)

**Problem**: Status line showed text "busy" instead of "Working on it..."

**Fix Applied**:

- **File**: `src/components/conversation/status-line.tsx`
- **Lines 417-420**: Return empty message for "busy"/"idle" to use default config
- **Line 281**: Changed "Working..." to "Working on it..."

### Fixed: Duplicate Question Tool Bubbles (COMPLETED)

**Problem**: Question tool appeared twice - once in question message, once in assistant message

**Fix Applied**:

- **File**: `src/components/conversation/conversation-panel.tsx`
- **Lines 440-443**: Skip question tool parts in assistant messages (already shown in question message)

---

## Architecture Notes

### Message Parts Flow

- Parts accumulate during streaming
- Get captured in messages when message completes
- Same part (same ID) can appear in multiple messages with different statuses
- Messages are immutable unless explicitly updated via store functions

### Activity Bubbles System

- Generated by `getActivityItems()` processing `message.parts` array
- 15 activity "kinds" (pills/badges) with different colors
- Special tools: Web and File get special treatment
- Hidden types: apply_patch, edit, patch, file.edited
- Step-finish parts should merge into preceding tool bubble

### Status Update Pattern

- Tool parts have `state.status`: "pending" → "running" → "completed"
- Status updates require explicit store function calls
- Must update both in-memory state and persist via API
- Use `updateMessageInProject()` in `src/lib/storage/projects.ts`

---

## Questions for Review

1. **Step-finish visibility**: Should step-finish parts with `reason="tool-calls"` be shown to users? They seem like internal metadata.

2. **Question tool status**: Should question tool bubbles show status updates, or is "running" sufficient since users see the actual question UI?

3. **Tool processing**: Is it acceptable to process but hide certain tools, or should we skip processing entirely?

---

## Test Project Reference

**Project ID**: `proj_1770307492294_oe1up1x`  
**URL**: `http://localhost:3000/project/proj_1770307492294_oe1up1x`  
**Description**: Test B - demonstrates both question tool status and step-finish orphan issues

---

## Investigation History

### 2026-02-05

- Identified and fixed "busy" status literal text display
- Identified and fixed duplicate question tool bubbles
- Documented question tool status update issue
- Documented step-finish orphan bubble issue
- Analyzed root causes and proposed solutions
