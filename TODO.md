# QuillBot TODO & Bug Investigation

## Current Issues

### 1. Question Tool Status Not Updating After Answer ❌

**Symptoms**:

- Question tool bubble shows status but doesn't update to "completed" after user answers
- Status remains stuck on "running" even though question has been answered

**Test Case**:

- Project: `proj_1770307492294_oe1up1x`
- URL: `http://localhost:3000/project/proj_1770307492294_oe1up1x` (Test B)

**Root Cause**:
The `answerQuestion()` function in `src/stores/project-store.ts` (lines 369-456) only updates:

- `questionData.answered = true`
- `questionData.answers = [...]`

But it does NOT update the question tool part's `state.status` from "running" to "completed".

**Solution**:
In `answerQuestion()`, after finding the question message, update the parts array:

```typescript
const updatedParts = m.parts?.map((part) => {
  if (part.type === "tool" && part.tool === "question") {
    return {
      ...part,
      state: {
        ...part.state,
        status: "completed" as const,
      },
    };
  }
  return part;
});
```

Then include `updatedParts` in the message update and persist via PATCH API.

**Files to Modify**:

- `src/stores/project-store.ts` - `answerQuestion()` function (lines 369-456)

---

### 2. Orphaned Step-Finish Bubbles ❌

**Symptoms**:

- Multiple standalone "[TOOL] Step finished (tool-calls)" bubbles appear in assistant messages
- They should merge into the preceding tool bubble but don't

**Test Case**: Same as above (Test B project)

**Root Cause**:
In `getActivityItems()` (`src/components/conversation/conversation-panel.tsx`, lines 544-562), step-finish parts try to merge into `lastToolIndex` (the last tool bubble). However:

1. Question tool parts are now skipped in assistant messages (line 441-443)
2. Apply_patch tool parts are skipped (line 436-438)
3. No tools remain to set `lastToolIndex`
4. Step-finish parts have nowhere to merge → create standalone bubbles

**Solution Options**:

**Option A: Process But Hide** (more complex)

- Remove skip at line 441-443
- Process question tool to set `lastToolIndex`
- Add `hidden: true` flag to ActivityItem
- Skip rendering hidden items
- Requires modifying ActivityItem type

**Option B: Cross-Message Merge** (very complex)

- Track last tool from previous message
- Have step-finish reference that for merging
- Requires significant refactoring

**Option C: Hide Step-Finish with tool-calls** (RECOMMENDED - simplest)

- Skip step-finish parts when `reason === "tool-calls"` in `getActivityItems()`
- Only show step-finish for meaningful reasons (stop, length, etc.)
- These seem like internal metadata not useful to users

**Files to Modify**:

- `src/components/conversation/conversation-panel.tsx` - `getActivityItems()` function

**Recommended Implementation (Option C)**:

```typescript
// Around line 560 in getActivityItems()
if (part.type === "step-finish") {
  // Skip internal tool-calls step-finish events
  if (part.reason === "tool-calls") {
    continue;
  }
  // ... rest of step-finish handling
}
```

---

## Recently Fixed Issues ✅

### Fixed: "busy" Status Shows Literal Text (COMPLETED)

**Problem**: Status line showed text "busy" instead of "Working on it..."

**Fix Applied**:

- **File**: `src/components/conversation/status-line.tsx`
- **Lines 417-420**: Return empty message for "busy"/"idle" to use default config
- **Line 281**: Changed "Working..." to "Working on it..."

### Fixed: Duplicate Question Tool Bubbles (COMPLETED)

**Problem**: Question tool appeared twice - once in question message, once in assistant message

**Fix Applied**:

- **File**: `src/components/conversation/conversation-panel.tsx`
- **Lines 440-443**: Skip question tool parts in assistant messages (already shown in question message)

---

## Architecture Notes

### Message Parts Flow

- Parts accumulate during streaming
- Get captured in messages when message completes
- Same part (same ID) can appear in multiple messages with different statuses
- Messages are immutable unless explicitly updated via store functions

### Activity Bubbles System

- Generated by `getActivityItems()` processing `message.parts` array
- 15 activity "kinds" (pills/badges) with different colors
- Special tools: Web and File get special treatment
- Hidden types: apply_patch, edit, patch, file.edited
- Step-finish parts should merge into preceding tool bubble

### Status Update Pattern

- Tool parts have `state.status`: "pending" → "running" → "completed"
- Status updates require explicit store function calls
- Must update both in-memory state and persist via API
- Use `updateMessageInProject()` in `src/lib/storage/projects.ts`

---

## Questions for Review

1. **Step-finish visibility**: Should step-finish parts with `reason="tool-calls"` be shown to users? They seem like internal metadata.

2. **Question tool status**: Should question tool bubbles show status updates, or is "running" sufficient since users see the actual question UI?

3. **Tool processing**: Is it acceptable to process but hide certain tools, or should we skip processing entirely?

---

## Test Project Reference

**Project ID**: `proj_1770307492294_oe1up1x`  
**URL**: `http://localhost:3000/project/proj_1770307492294_oe1up1x`  
**Description**: Test B - demonstrates both question tool status and step-finish orphan issues

---

## Investigation History

### 2026-02-05

- Identified and fixed "busy" status literal text display
- Identified and fixed duplicate question tool bubbles
- Documented question tool status update issue
- Documented step-finish orphan bubble issue
- Analyzed root causes and proposed solutions
