╔════════════════════════════════════════════════════════════════════════════╗
║         QUILLBOT AGENT INTEGRATION - INVESTIGATION SUMMARY                 ║
║                      No File Changes Made - Analysis Only                  ║
╚════════════════════════════════════════════════════════════════════════════╝

EXECUTIVE SUMMARY
═══════════════════════════════════════════════════════════════════════════

The QuillBot agent is configured in opencode-config/opencode.json with:
  • Mode: primary agent
  • Model: github-copilot/gpt-5.2  
  • Allowed: file ops (read/write/edit/patch), web search/fetch, questions
  • Denied: bash, lsp, delegation, todos

To use this agent in API calls, you must pass agent: "quillbot" parameter 
to OpenCode SDK's promptAsync() method.


KEY FINDINGS
═══════════════════════════════════════════════════════════════════════════

1. AGENT NOT SPECIFIABLE AT SESSION CREATION
   Location: client.session.create()
   Parameters: directory, parentID, title, permission
   Finding: Agent cannot be set when creating sessions - only per-prompt

2. AGENT SPECIFIABLE IN PROMPT CALLS ✅
   Location: client.session.promptAsync()
   New Parameter: agent?: string
   Example: agent: "quillbot"
   
   Also available in: client.session.command()

3. TWO ROUTES NEED UPDATES
   a) src/app/api/opencode/message/route.ts
      - Main conversation flow
      - 2 promptAsync() calls need agent parameter
      
   b) src/app/api/opencode/analyze-brief/route.ts  
      - Content analysis flow
      - 1 promptAsync() call needs agent parameter
      - Uses different model (claude-haiku-4.5)


DATA FLOW: Client → Hook → API Route → OpenCode SDK
═══════════════════════════════════════════════════════════════════════════

CLIENT SIDE (useOpenCodeStream hook)
┌─────────────────────────────────────────────────────────────┐
│ src/hooks/use-opencode-stream.ts                            │
│                                                             │
│ sendMessage() posts to /api/opencode/message:              │
│ {                                                           │
│   sessionId?: string                                        │
│   projectId: string                                         │
│   message: string                                           │
│   command?: string                                          │
│   agent?: string              ← NEEDS ADDITION              │
│ }                                                           │
└─────────────────────────────────────────────────────────────┘
                          ↓
SERVER API ROUTE
┌─────────────────────────────────────────────────────────────┐
│ src/app/api/opencode/message/route.ts                       │
│                                                             │
│ RequestBody interface:                                      │
│ {                                                           │
│   sessionId?: string                                        │
│   projectId: string                                         │
│   message: string                                           │
│   command?: string                                          │
│   agent?: string              ← NEEDS ADDITION              │
│ }                                                           │
│                                                             │
│ client.session.promptAsync({                               │
│   sessionID: targetSessionId                               │
│   directory: project.directoryPath                         │
│   agent: body.agent || "quillbot"  ← PASS HERE (2x)        │
│   parts: [{ type: "text", text: message }]                │
│ })                                                          │
└─────────────────────────────────────────────────────────────┘
                          ↓
OPENCODE SDK
┌─────────────────────────────────────────────────────────────┐
│ @opencode-ai/sdk/v2                                         │
│                                                             │
│ promptAsync parameters:                                     │
│ {                                                           │
│   sessionID: string                                         │
│   directory?: string                                        │
│   agent?: string              ← RECEIVED HERE               │
│   model?: {...}                                             │
│   tools?: {...}                                             │
│   parts: Array<...>                                         │
│ }                                                           │
└─────────────────────────────────────────────────────────────┘
                          ↓
OPENCODE SERVER
┌─────────────────────────────────────────────────────────────┐
│ Reads opencode-config/opencode.json                         │
│ agent.quillbot configuration                               │
│                                                             │
│ Applies QuillBot restrictions:                             │
│ ✓ File operations (read/write/edit/patch)                  │
│ ✓ Research (question/websearch/webfetch)                   │
│ ✗ System commands (bash denied)                            │
│ ✗ Delegation (task/todo not available)                     │
└─────────────────────────────────────────────────────────────┘


IMPLEMENTATION CHECKLIST
═══════════════════════════════════════════════════════════════════════════

MINIMAL CHANGES (Always use QuillBot):

☐ 1. src/hooks/use-opencode-stream.ts
      ├─ Add to SendMessageOptions interface: agent?: string
      └─ In sendMessage(): extract agent, pass in fetch body

☐ 2. src/app/api/opencode/message/route.ts  
      ├─ Add to RequestBody interface: agent?: string
      └─ In promptAsync() calls (2x): add agent: body.agent || "quillbot"

☐ 3. src/app/api/opencode/analyze-brief/route.ts
      └─ In promptAsync() call: add agent: "quillbot"


OPTIONAL ENHANCEMENTS:

☐ 4. Add agent selector UI
      └─ src/components/conversation/conversation-panel.tsx

☐ 5. Create separate agent config for analysis
      └─ Add to opencode-config/opencode.json: agent.analyzer

☐ 6. Update ConversationPanel props
      └─ Allow selecting agent before sending message


TESTING PLAN
═══════════════════════════════════════════════════════════════════════════

1. Test QuillBot with file operations
   └─ Send message: "Create a file test.md with content 'hello'"
   └─ Verify: QuillBot can write files ✓

2. Test QuillBot denies bash
   └─ Send message: "Run 'whoami' command"
   └─ Verify: OpenCode blocks bash execution ✓

3. Test QuillBot denies delegation
   └─ Send message: "Use an oracle agent to review this code"
   └─ Verify: Delegation is blocked ✓

4. Test web search works
   └─ Send message: "Search for OpenCode documentation"
   └─ Verify: websearch/webfetch work ✓

5. Test session recreation with agent
   └─ Create session → send message → kill session → send message again
   └─ Verify: Agent specified on retry ✓


ALTERNATIVE APPROACHES CONSIDERED
═══════════════════════════════════════════════════════════════════════════

❌ Approach A: Set agent at session creation
   Reason: OpenCode SDK doesn't support agent in session.create()
           Must specify per-prompt instead

❌ Approach B: Use multiple agents automatically
   Reason: Would require agent selection logic
           Keep it simple: default to QuillBot for now

✓ Approach C: Pass agent in promptAsync (CHOSEN)
   Reason: Simple, explicit, follows SDK design
           Can be enhanced later with UI selection


CONFIGURATION DETAILS
═══════════════════════════════════════════════════════════════════════════

Location: opencode-config/opencode.json
Agent Name: "quillbot"

Full Configuration:
{
  "agent": {
    "quillbot": {
      "description": "QuillBot - Content authoring agent with file ops and research",
      "mode": "primary",
      "model": "github-copilot/gpt-5.2",
      "tools": {
        "read": true,
        "write": true,
        "edit": true,
        "apply_patch": true,
        "question": true,
        "websearch": true,
        "webfetch": true,
        "bash": false,
        "lsp": false
      },
      "permission": {
        "edit": "allow",
        "bash": "deny"
      }
    }
  }
}

When calling: client.session.promptAsync({ agent: "quillbot", ... })
OpenCode loads this config and applies all restrictions.


EDGE CASES & CONSIDERATIONS
═══════════════════════════════════════════════════════════════════════════

1. Agent name mismatch
   → If agent: "unknown" specified and not in config
   → OpenCode SDK will error appropriately
   → Good: Forces explicit agent configuration

2. Permission vs tool disable
   → "bash": "deny" in permission blocks all bash
   → "bash": false in tools also disables
   → Redundant for safety (both mechanisms work)

3. Model override in promptAsync
   → Can pass model even with agent specified
   → Agent tools/permissions still apply
   → Model param: { providerID: "...", modelID: "..." }

4. Backward compatibility
   → If agent param omitted: OpenCode uses session default
   → Could default all sessions to QuillBot in opencode.json
   → Or let promptAsync agent param override


DOCUMENTATION RECOMMENDATIONS
═══════════════════════════════════════════════════════════════════════════

1. Add to code comments
   └─ "agent: 'quillbot' ensures no bash/delegation allowed"

2. Update API docs
   └─ /api/opencode/message accepts agent parameter

3. Add to AGENTS.md
   └─ QuillBot agent purpose and restrictions

4. Create agent selection guide
   └─ When to use QuillBot vs other agents


═══════════════════════════════════════════════════════════════════════════
Investigation Complete - Ready for Implementation
═══════════════════════════════════════════════════════════════════════════
